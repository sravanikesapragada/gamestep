<!DOCTYPE html>
<html>
<head>
  <title>Stepper Race Game</title>
  <style>
    body {
      text-align: center;
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .game-container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    canvas {
      background: linear-gradient(to bottom, #1e5799, #2989d8);
      display: block;
      margin: 20px auto;
      border: 4px solid #000;
      border-radius: 10px;
    }
    
    .setup-page {
      margin: 20px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    
    button {
      padding: 15px 25px;
      margin: 10px;
      font-size: 18px;
      cursor: pointer;
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    input {
      padding: 12px;
      margin: 8px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #3498db;
      background: rgba(255,255,255,0.9);
      width: 200px;
    }
    
    #gameControls {
      margin: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
    }
    
    .player-btn {
      font-size: 20px;
      font-weight: bold;
      min-width: 140px;
      margin: 8px;
      padding: 12px 20px;
    }
    
    .p1 { background: linear-gradient(45deg, #e74c3c, #c0392b); }
    .p2 { background: linear-gradient(45deg, #3498db, #2980b9); }
    .p3 { background: linear-gradient(45deg, #2ecc71, #27ae60); }
    .p4 { background: linear-gradient(45deg, #f39c12, #d35400); }
    
    .player-btn:hover {
      transform: scale(1.05);
    }
    
    /* Animations */
    @keyframes moveUp {
      0% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-8px) scale(1.1); }
      100% { transform: translateY(0px) scale(1); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    .moving {
      animation: moveUp 0.4s ease-in-out;
    }
    
    .bounce {
      animation: bounce 0.3s ease-in-out;
    }
    
    /* Enhanced Confetti */
    .confetti {
      position: fixed;
      width: 15px;
      height: 15px;
      pointer-events: none;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    @keyframes confetti-spiral {
      0% { transform: translateY(-100px) rotate(0deg) translateX(0); opacity: 1; }
      50% { transform: translateY(50vh) rotate(180deg) translateX(100px); opacity: 0.8; }
      100% { transform: translateY(100vh) rotate(360deg) translateX(0); opacity: 0; }
    }
    
    @keyframes confetti-wave {
      0% { transform: translateY(-100px) translateX(-100px) rotate(0deg); opacity: 1; }
      50% { transform: translateY(50vh) translateX(0) rotate(180deg); opacity: 0.8; }
      100% { transform: translateY(100vh) translateX(100px) rotate(360deg); opacity: 0; }
    }
    
    @keyframes confetti-explode {
      0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0) rotate(720deg); opacity: 0; }
    }
    
    /* Simple Winner Display */
    .winner-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      z-index: 2001;
      box-shadow: 0 0 50px rgba(255,255,255,0.5);
      border: 3px solid gold;
      pointer-events: auto;
    }
    
    .winner-display h2 {
      font-size: 2.5em;
      margin: 0;
      color: gold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .winner-display p {
      font-size: 3em;
      margin: 20px 0;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .firework {
      position: fixed;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1000;
    }
    
    @keyframes firework {
      0% { transform: translate(var(--x), var(--y)) scale(0); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translate(var(--x), var(--y)) scale(1); opacity: 0; }
    }
    
    /* Page transitions */
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    .nav-buttons {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- Player Selection Page -->
    <div id="playerSelection" class="setup-page page active">
      <h2>üéÆ Select Number of Players</h2>
      <button onclick="selectPlayers(1)">1 Player</button>
      <button onclick="selectPlayers(2)">2 Players</button>
      <button onclick="selectPlayers(3)">3 Players</button>
      <button onclick="selectPlayers(4)">4 Players</button>
    </div>
    
    <!-- Name Entry Page -->
    <div id="nameEntry" class="setup-page page">
      <h2>üë§ Enter Player Names</h2>
      <div id="nameInputs"></div>
      <div class="nav-buttons">
        <button onclick="goBackToSelection()">‚Üê Back</button>
        <button onclick="startGame()">üöÄ Start Game</button>
      </div>
    </div>
    
    <!-- Game Page -->
    <div id="gamePage" class="page">
      <!-- Game Canvas - Made taller for longer track -->
      <canvas id="gameCanvas" width="500" height="800"></canvas>
      
      <div id="gameControls">
        <button class="player-btn p1" onclick="movePlayer(1)">Move Player 1</button>
        <button class="player-btn p2" onclick="movePlayer(2)">Move Player 2</button>
        <button class="player-btn p3" onclick="movePlayer(3)">Move Player 3</button>
        <button class="player-btn p4" onclick="movePlayer(4)">Move Player 4</button>
      </div>
    </div>
  </div>

  <script>
    let players = [];
    let totalPlayers = 1;
    let gameRunning = false;
    let playerNames = [];
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Game settings for longer track
    const TRACK_LENGTH = 700; // Increased from 550 to make it longer
    const STEP_SIZE = 25; // Smaller steps to make game longer
    const FINISH_LINE = 50;

    const carEmojis = ["üöó", "üöô", "üèéÔ∏è", "üöï"];
    const colors = ["#e74c3c", "#3498db", "#2ecc71", "#f39c12"];
    const colorNames = ["Red", "Blue", "Green", "Yellow"];
    
    // Track key states to prevent key repeat
    let keysPressed = {};

    function selectPlayers(numPlayers) {
      totalPlayers = numPlayers;
      
      // Hide player selection, show name entry
      document.getElementById("playerSelection").classList.remove("active");
      document.getElementById("nameEntry").classList.add("active");
      
      // Create name inputs
      const nameInputs = document.getElementById("nameInputs");
      nameInputs.innerHTML = "";
      
      for (let i = 0; i < numPlayers; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `${colorNames[i]} Player Name`;
        input.id = `player${i+1}Name`;
        input.value = `${colorNames[i]} Racer`;
        nameInputs.appendChild(input);
        nameInputs.appendChild(document.createElement("br"));
      }
    }

    function goBackToSelection() {
      // Hide name entry, show player selection
      document.getElementById("nameEntry").classList.remove("active");
      document.getElementById("playerSelection").classList.add("active");
    }

    function startGame() {
      // Get player names
      playerNames = [];
      for (let i = 0; i < totalPlayers; i++) {
        const name = document.getElementById(`player${i+1}Name`).value || `${colorNames[i]} Racer`;
        playerNames.push(name);
      }
      
      // Initialize players at the bottom
      players = [];
      let laneWidth = canvas.width / totalPlayers;
      for (let i = 0; i < totalPlayers; i++) {
        players.push({
          x: laneWidth * i + laneWidth / 2 - 20,
          y: canvas.height - 60, // Start position
          color: colors[i],
          car: carEmojis[i],
          lane: i,
          name: playerNames[i],
          moving: false,
          progress: 0
        });
      }

      gameRunning = true;
      
      // Hide name entry, show game page
      document.getElementById("nameEntry").classList.remove("active");
      document.getElementById("gamePage").classList.add("active");

      requestAnimationFrame(draw);
    }

    function movePlayer(p) {
      if (p <= players.length && p > 0 && gameRunning) {
        // Add movement animation
        players[p - 1].moving = true;
        setTimeout(() => {
          players[p - 1].moving = false;
        }, 400);
        
        // Move player
        players[p - 1].y -= STEP_SIZE;
        
        // Check win
        checkWin(p);
        
        // Button animation
        const button = document.querySelector(`.player-btn.p${p}`);
        button.classList.add('bounce');
        setTimeout(() => {
          button.classList.remove('bounce');
        }, 300);
      }
    }

    function checkWin(p) {
      if (players[p - 1].y <= FINISH_LINE) {
        gameRunning = false;
        const winnerName = playerNames[p - 1];
        const winnerColor = colors[p - 1];
        
        // Create enhanced celebration
        createEnhancedConfetti(winnerColor);
        createFireworks();
        
        setTimeout(() => {
          showWinner(winnerName);
        }, 1000);
      }
    }

    function showWinner(winnerName) {
      const winnerDiv = document.createElement('div');
      winnerDiv.className = 'winner-display';
      winnerDiv.innerHTML = `
        <h2>WINNER</h2>
        <p>${winnerName}</p>
        <button onclick="location.reload()" style="
          padding: 10px 20px;
          font-size: 1em;
          background: gold;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          margin-top: 20px;
          color: black;
          font-weight: bold;
        ">Play Again</button>
      `;
      document.body.appendChild(winnerDiv);
      
      // Add confetti directly to the winner popup
      createWinnerConfetti();
    }

    function createWinnerConfetti() {
      const winnerDiv = document.querySelector('.winner-display');
      const confettiColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
      
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          
          // Random size and shape
          const size = Math.random() * 10 + 5;
          confetti.style.width = `${size}px`;
          confetti.style.height = `${size}px`;
          
          // Random color
          confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
          
          // Position inside winner popup
          confetti.style.position = 'absolute';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.top = Math.random() * 100 + '%';
          
          // Random animation type
          const animationType = Math.floor(Math.random() * 3);
          let animationName = 'confetti-fall';
          let animationDuration = Math.random() * 3 + 2;
          
          if (animationType === 1) {
            animationName = 'confetti-spiral';
            animationDuration = Math.random() * 4 + 3;
          } else if (animationType === 2) {
            animationName = 'confetti-wave';
            animationDuration = Math.random() * 3 + 2;
          }
          
          confetti.style.animation = `${animationName} ${animationDuration}s linear forwards`;
          
          // Random rotation
          confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
          
          winnerDiv.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), animationDuration * 1000);
        }, i * 100);
      }
    }

    function createEnhancedConfetti(color) {
      const confettiColors = [color, '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e74c3c'];
      
      // Create multiple types of confetti with different animations
      for (let i = 0; i < 200; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          
          // Random size and shape
          const size = Math.random() * 15 + 5;
          confetti.style.width = `${size}px`;
          confetti.style.height = `${size}px`;
          
          // Random color
          confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
          
          // Random position
          confetti.style.left = Math.random() * 100 + 'vw';
          
          // Random animation type
          const animationType = Math.floor(Math.random() * 3);
          let animationName = 'confetti-fall';
          let animationDuration = Math.random() * 3 + 2;
          
          if (animationType === 1) {
            animationName = 'confetti-spiral';
            animationDuration = Math.random() * 4 + 3;
          } else if (animationType === 2) {
            animationName = 'confetti-wave';
            animationDuration = Math.random() * 3 + 2;
          }
          
          confetti.style.animation = `${animationName} ${animationDuration}s linear forwards`;
          
          // Random rotation
          confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
          
          document.body.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), animationDuration * 1000);
        }, i * 20);
      }
    }

    function createFireworks() {
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          firework.style.left = `${Math.random() * 100}vw`;
          firework.style.top = `${Math.random() * 100}vh`;
          
          // Random explosion direction and distance
          const tx = (Math.random() - 0.5) * 200;
          const ty = (Math.random() - 0.5) * 200;
          firework.style.setProperty('--tx', `${tx}px`);
          firework.style.setProperty('--ty', `${ty}px`);
          
          firework.style.animation = `firework ${Math.random() * 1 + 0.5}s ease-out forwards`;
          
          document.body.appendChild(firework);
          
          setTimeout(() => firework.remove(), 1500);
        }, i * 150);
      }
    }

    function drawTrack() {
      // Sky with gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, "#1e5799");
      gradient.addColorStop(1, "#2989d8");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw clouds
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      drawCloud(100, 80, 30);
      drawCloud(300, 120, 25);
      drawCloud(400, 180, 35);
      drawCloud(200, 250, 28);
      drawCloud(350, 350, 32);

      // Road
      ctx.fillStyle = "#2c3e50";
      ctx.fillRect(60, 0, canvas.width - 120, canvas.height);

      // Road markings - center line
      ctx.strokeStyle = "yellow";
      ctx.lineWidth = 3;
      ctx.setLineDash([20, 20]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]);

      // Lane dividers
      let laneWidth = (canvas.width - 120) / totalPlayers;
      ctx.strokeStyle = "white";
      ctx.lineWidth = 2;
      for (let i = 1; i < totalPlayers; i++) {
        let x = 60 + laneWidth * i;
        ctx.setLineDash([15, 25]);
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // Finish line - checkered flag
      ctx.fillStyle = "white";
      ctx.fillRect(60, FINISH_LINE, canvas.width - 120, 15);
      
      // Checkered pattern
      ctx.fillStyle = "black";
      const checkSize = 20;
      for (let i = 0; i < Math.floor((canvas.width - 120) / checkSize); i++) {
        for (let j = 0; j < 2; j++) {
          if ((i + j) % 2 === 0) {
            ctx.fillRect(60 + i * checkSize, FINISH_LINE + j * checkSize/2, checkSize, checkSize/2);
          }
        }
      }
      
      // Start line
      ctx.fillStyle = "white";
      ctx.fillRect(60, canvas.height - 60, canvas.width - 120, 5);
      
      // Distance markers every 100 pixels
      ctx.fillStyle = "white";
      ctx.font = "12px Arial";
      ctx.textAlign = "right";
      for (let y = canvas.height - 100; y > FINISH_LINE; y -= 100) {
        ctx.fillText(`${Math.round((canvas.height - 60 - y) / STEP_SIZE)}`, 50, y);
        ctx.fillRect(55, y, 5, 2);
      }
    }
    
    function drawCloud(x, y, size) {
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.arc(x + size * 0.8, y - size * 0.2, size * 0.8, 0, Math.PI * 2);
      ctx.arc(x + size * 1.5, y, size * 0.7, 0, Math.PI * 2);
      ctx.arc(x + size * 0.8, y + size * 0.2, size * 0.8, 0, Math.PI * 2);
      ctx.fill();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawTrack();

      // Draw players
      players.forEach((p, i) => {
        // Draw car with shadow effect when moving
        if (p.moving) {
          ctx.shadowColor = p.color;
          ctx.shadowBlur = 15;
        }
        
        ctx.font = "35px Arial";
        ctx.textAlign = "center";
        ctx.fillText(p.car, p.x + 25, p.y + 35);
        
        // Reset shadow
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
        
        // Draw player name
        ctx.fillStyle = "white";
        ctx.font = "bold 14px Arial";
        ctx.fillText(p.name, p.x + 25, p.y - 10);
        
        // Draw speed effect when moving
        if (p.moving) {
          ctx.strokeStyle = p.color;
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.strokeRect(p.x, p.y, 50, 50);
          ctx.setLineDash([]);
        }
      });

      if (gameRunning) requestAnimationFrame(draw);
    }

    // Keyboard controls with anti-repeat
    document.addEventListener("keydown", (e) => {
      if (!gameRunning || keysPressed[e.key]) return;
      
      keysPressed[e.key] = true;
      
      if (e.key === "1") movePlayer(1);
      if (e.key === "2") movePlayer(2);
      if (e.key === "3") movePlayer(3);
      if (e.key === "4") movePlayer(4);
    });

    document.addEventListener("keyup", (e) => {
      keysPressed[e.key] = false;
    });
  </script>
</body>
</html>